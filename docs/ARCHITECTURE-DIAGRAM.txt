```
SmrutiCortex - Two UI Architecture with Shared Code Layer
=========================================================

┌──────────────────────────────────────────────────────────────────────┐
│                         USER INTERACTIONS                            │
└──────────────────┬───────────────────────────────────┬───────────────┘
                   │                                   │
         Ctrl+Shift+S on regular pages      Toolbar click OR special pages
                   │                                   │
                   ▼                                   ▼
┌──────────────────────────────────┐  ┌──────────────────────────────────┐
│   INLINE OVERLAY                 │  │   EXTENSION POPUP                │
│   (Content Script)               │  │   (Traditional Popup)            │
├──────────────────────────────────┤  ├──────────────────────────────────┤
│ File: quick-search.ts            │  │ File: popup.ts                   │
│                                  │  │                                  │
│ Features:                        │  │ Features:                        │
│ • Shadow DOM (closed)            │  │ • Popup Mode (dropdown)          │
│ • < 50ms response time           │  │ • Tab Mode (centered card)       │
│ • CSS isolation                  │  │ • 200-800ms response             │
│ • Always active in page          │  │ • Settings access                │
│ • Pre-created overlay            │  │ • Bookmarking feature            │
│ • Port-based messaging           │  │ • Full feature set               │
│                                  │  │                                  │
│ Use Case: PRIMARY INTERFACE      │  │ Use Case: FALLBACK & SETTINGS    │
└──────────┬───────────────────────┘  └───────────┬──────────────────────┘
           │                                      │
           │  Both import from shared layer      │
           │                                      │
           └──────────┬───────────────────────────┘
                      │
                      ▼
┌─────────────────────────────────────────────────────────────────────┐
│                    SHARED ABSTRACTION LAYER                         │
│                    src/shared/search-ui-base.ts                     │
├─────────────────────────────────────────────────────────────────────┤
│                                                                     │
│  ┌──────────────────────────────────────────────────────────────┐ │
│  │ INTERFACES & TYPES                                           │ │
│  ├──────────────────────────────────────────────────────────────┤ │
│  │ • SearchResult - Common result data model                    │ │
│  │ • KeyboardAction - Standardized keyboard actions enum        │ │
│  │ • ISearchUI - Interface both UIs can implement               │ │
│  │ • RenderOptions - Configuration for result rendering         │ │
│  │ • TextSegment - Highlighted text structure                   │ │
│  └──────────────────────────────────────────────────────────────┘ │
│                                                                     │
│  ┌──────────────────────────────────────────────────────────────┐ │
│  │ SHARED UTILITIES (DRY Principle)                             │ │
│  ├──────────────────────────────────────────────────────────────┤ │
│  │ • highlightText() - Token-based text highlighting            │ │
│  │ • appendHighlightedTextToDOM() - CSP-safe DOM highlighting   │ │
│  │ • parseKeyboardAction() - Keyboard event → action mapping    │ │
│  │ • createMarkdownLink() - Generate markdown from result       │ │
│  │ • openUrl() - Open with tab/background support               │ │
│  │ • renderResults() - Generic result rendering                 │ │
│  │ • truncateUrl() - URL display truncation                     │ │
│  │ • escapeRegex() - Regex escaping utility                     │ │
│  │ • debounce() - Debouncing function                           │ │
│  └──────────────────────────────────────────────────────────────┘ │
│                                                                     │
│  Benefits:                                                          │
│  ✓ Single source of truth                                          │
│  ✓ Update once, both UIs benefit                                   │
│  ✓ Type-safe interfaces                                            │
│  ✓ Easier testing                                                  │
│  ✓ Future-proof for new UIs                                        │
└──────────┬──────────────────────────────────────────────────────────┘
           │
           │  Both UIs call service worker
           │
           ▼
┌─────────────────────────────────────────────────────────────────────┐
│                      SERVICE WORKER LAYER                           │
│                   src/background/service-worker.ts                  │
├─────────────────────────────────────────────────────────────────────┤
│                                                                     │
│ • Command Handler - Routes Ctrl+Shift+S                            │
│ • Port-based Messaging - Fast search-as-you-type                   │
│ • Search Engine Integration - search-engine.ts                     │
│   ├─ Strict Matching Mode - Only show results with query matches   │
│   ├─ Literal Substring Boost - 50% boost for exact matches         │
│   ├─ Diversity Filter - Filter duplicate URLs (diversity-filter.ts)│
│   └─ Scorer Manager - Modular scoring algorithms                   │
│ • IndexedDB Access - database.ts                                   │
│ • Message Routing - OPEN_INLINE_SEARCH, OPEN_SETTINGS, etc.        │
│                                                                     │
└──────────┬──────────────────────────────────────────────────────────┘
           │
           ▼
┌─────────────────────────────────────────────────────────────────────┐
│                         DATA LAYER                                  │
├─────────────────────────────────────────────────────────────────────┤
│ • IndexedDB (local storage)                                         │
│ • Chrome History API (fallback)                                     │
│ • Real-time indexing                                                │
└─────────────────────────────────────────────────────────────────────┘


CODE FLOW EXAMPLE: Keyboard Shortcut → Search
==============================================

1. User presses Ctrl+Shift+S
   ↓
2. Inline Overlay: parseKeyboardAction(e) from shared layer
   ↓
3. Returns KeyboardAction.OPEN (from shared enum)
   ↓
4. Overlay sends search query via port to service worker
   ↓
5. Service worker executes search
   ↓
6. Results returned to overlay
   ↓
7. renderResults() from shared layer creates DOM
   ↓
8. User presses Ctrl+M
   ↓
9. parseKeyboardAction() → KeyboardAction.COPY_MARKDOWN
   ↓
10. createMarkdownLink() from shared layer generates markdown
    ↓
11. Clipboard.writeText() copies markdown


BEFORE vs AFTER Refactoring
============================

BEFORE (Code Duplication):
--------------------------
quick-search.ts:         popup.ts:
├─ highlightText()       ├─ highlightMatches()     ← DUPLICATE!
├─ truncateUrl()         ├─ truncateUrl()          ← DUPLICATE!
├─ escapeRegex()         ├─ escapeRegex()          ← DUPLICATE!
├─ openResult()          ├─ openResult()           ← DUPLICATE!
├─ copyMarkdown()        ├─ copyMarkdown()         ← DUPLICATE!
└─ handleKeydown()       └─ handleKeydown()        ← DUPLICATE!

❌ Problem: Update one, forget the other → bugs!


AFTER (Shared Abstraction):
---------------------------
search-ui-base.ts:       quick-search.ts:          popup.ts:
├─ highlightText()       ├─ import shared ──────┐  ├─ import shared
├─ truncateUrl()         ├─ use shared utils    │  ├─ use shared utils
├─ escapeRegex()         ├─ UI-specific code    │  ├─ UI-specific code
├─ createMarkdownLink()  └─ Shadow DOM setup    │  └─ Popup layout
├─ openUrl()                                     │
├─ parseKeyboardAction() ← SINGLE SOURCE ────────┘
└─ renderResults()

✅ Solution: Update once, both UIs benefit!


TERMINOLOGY FOR EASY DISCUSSION
================================

1. "Inline Overlay" or "Overlay"
   - The fast Shadow DOM content script UI
   - File: quick-search.ts
   - Usage: "The overlay needs a new feature"

2. "Extension Popup" or "Popup"  
   - The traditional toolbar dropdown UI
   - File: popup.ts
   - Usage: "The popup has settings access"

3. "Shared Layer" or "Base"
   - The common utilities and interfaces
   - File: search-ui-base.ts
   - Usage: "Add the new function to the shared layer"

4. "Tab Mode"
   - When popup.html opens as a full browser tab
   - Usage: "Tab mode has a centered layout"

5. "Popup Mode"
   - When popup.html opens as toolbar dropdown
   - Usage: "Popup mode is constrained to 600x600px"
```
