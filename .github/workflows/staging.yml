name: Staging Build

# Purpose: Automated staging builds from develop branch for pre-release testing.
# Produces: staging-extension artifact (14 days) for manual testing.
# Use case: Test changes in develop before merging to main/production.
# Note: Does NOT auto-deploy - creates artifacts for manual testing only.

on:
  push:
    branches: [develop]
  pull_request:
    branches: [develop]
  workflow_dispatch:
    inputs:
      test_type:
        description: 'Type of testing to perform'
        required: false
        default: 'functional'
        type: choice
        options:
          - functional
          - performance
          - integration
          - all

jobs:
  staging-build:
    name: Build Staging Extension
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js 22
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Add staging marker to manifest
        run: |
          # Add " (STAGING)" to extension name in manifest
          node -e "
            const fs = require('fs');
            const manifest = JSON.parse(fs.readFileSync('manifest.json', 'utf8'));
            manifest.name = manifest.name + ' (STAGING)';
            manifest.version = manifest.version + '.dev';
            fs.writeFileSync('manifest.json', JSON.stringify(manifest, null, 2));
          "
          
          echo "âœ… Manifest updated for staging" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo '```json' >> $GITHUB_STEP_SUMMARY
          cat manifest.json | head -10 >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
      
      - name: Run tests (if requested)
        if: inputs.test_type == 'all' || inputs.test_type == 'functional'
        run: |
          echo "## ðŸ§ª Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          npm test -- --reporter=json > test-results.json 2>&1 || true
          
          TESTS_PASSED=$(jq '.numPassedTests // 0' test-results.json 2>/dev/null || echo "0")
          TESTS_FAILED=$(jq '.numFailedTests // 0' test-results.json 2>/dev/null || echo "0")
          TESTS_TOTAL=$(jq '.numTotalTests // 0' test-results.json 2>/dev/null || echo "0")
          
          echo "| Metric | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| âœ… Passed | $TESTS_PASSED |" >> $GITHUB_STEP_SUMMARY
          echo "| âŒ Failed | $TESTS_FAILED |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ“Š Total | $TESTS_TOTAL |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "$TESTS_FAILED" -gt 0 ]; then
            echo "::warning::$TESTS_FAILED tests failed in staging build"
          fi
      
      - name: Lint check
        run: |
          echo "## ðŸ“ Linting Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          npm run lint > lint.txt 2>&1 || true
          LINT_WARNINGS=$(grep -c "warning" lint.txt 2>/dev/null || echo "0")
          LINT_ERRORS=$(grep -c "error" lint.txt 2>/dev/null || echo "0")
          
          echo "| Type | Count |" >> $GITHUB_STEP_SUMMARY
          echo "|------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Errors | $LINT_ERRORS |" >> $GITHUB_STEP_SUMMARY
          echo "| Warnings | $LINT_WARNINGS |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "$LINT_ERRORS" -gt 0 ]; then
            echo "âš ï¸ **Linting errors found - review recommended**" >> $GITHUB_STEP_SUMMARY
          else
            echo "âœ… No linting errors" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
      
      - name: Build staging extension
        run: |
          npm run build:prod
          
          echo "## ðŸ“¦ Staging Build" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… Staging extension built successfully" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Build artifacts:**" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          ls -lh dist/ | head -20 >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
      
      - name: Package staging extension
        run: |
          npm run package
          mv dist/smruti-cortex.zip dist/smruti-cortex-staging.zip
          
          SIZE=$(ls -lh dist/smruti-cortex-staging.zip | awk '{print $5}')
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Package size:** $SIZE" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
      
      - name: Upload staging artifact
        uses: actions/upload-artifact@v4
        with:
          name: smruti-cortex-staging
          path: dist/smruti-cortex-staging.zip
          retention-days: 14
          compression-level: 0  # Already compressed
      
      - name: Staging Summary
        run: |
          echo "## ðŸš€ Staging Build Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Status:** âœ… Build Complete" >> $GITHUB_STEP_SUMMARY
          echo "**Branch:** \`develop\`" >> $GITHUB_STEP_SUMMARY
          echo "**Artifact:** \`smruti-cortex-staging\`" >> $GITHUB_STEP_SUMMARY
          echo "**Retention:** 14 days" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“¥ How to Test" >> $GITHUB_STEP_SUMMARY
          echo "1. Download the \`smruti-cortex-staging\` artifact from this workflow" >> $GITHUB_STEP_SUMMARY
          echo "2. Extract the ZIP file" >> $GITHUB_STEP_SUMMARY
          echo "3. Open Chrome and navigate to \`chrome://extensions\`" >> $GITHUB_STEP_SUMMARY
          echo "4. Enable \"Developer mode\"" >> $GITHUB_STEP_SUMMARY
          echo "5. Click \"Load unpacked\" and select the extracted folder" >> $GITHUB_STEP_SUMMARY
          echo "6. Test the staging build thoroughly" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### âœ… Pre-Production Checklist" >> $GITHUB_STEP_SUMMARY
          echo "- [ ] All tests passing" >> $GITHUB_STEP_SUMMARY
          echo "- [ ] No linting errors" >> $GITHUB_STEP_SUMMARY
          echo "- [ ] Manual testing completed" >> $GITHUB_STEP_SUMMARY
          echo "- [ ] Performance acceptable" >> $GITHUB_STEP_SUMMARY
          echo "- [ ] Security scan passed" >> $GITHUB_STEP_SUMMARY
          echo "- [ ] Ready to merge to main" >> $GITHUB_STEP_SUMMARY
