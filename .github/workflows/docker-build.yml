name: Docker Build & Verify

# Purpose: Validates that extension can be built in a clean Docker environment.
# Produces: extension-dist-docker artifact (dist/ folder) AND smruti-cortex-docker.zip (ready-to-install).
# Use case: Ensures reproducible builds across different host environments.
# Note: Does NOT commit/push any changes back to repository.

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]
  workflow_dispatch:
    inputs:
      target_branch:
        description: 'Branch to build from (default: main)'
        required: false
        default: 'main'
        type: string
      docker_tag:
        description: 'Custom Docker tag (default: auto-generated from package.json)'
        required: false
        type: string
      skip_tests:
        description: 'Skip running tests in Docker'
        required: false
        default: false
        type: boolean

jobs:
  docker-build:
    name: Build with Docker Compose
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ inputs.target_branch || 'main' }}
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: Resolve version tag
        run: |
          # Use custom tag if provided, otherwise use package version
          if [ -n "${{ inputs.docker_tag }}" ]; then
            echo "SMRUTI_CORTEX_VERSION=${{ inputs.docker_tag }}" >> $GITHUB_ENV
          else
            node -e "console.log('SMRUTI_CORTEX_VERSION=' + require('./package.json').version)" >> $GITHUB_ENV
          fi

      - name: Build Docker image
        run: docker build -t smruti-cortex:${{ env.SMRUTI_CORTEX_VERSION }} .
      
      - name: Run Docker Compose build
        env:
          # Map container /output to workspace so dist/ appears on runner
          DOCKER_OUTPUT_DIR: .
        run: |
          echo "ðŸ‹ Starting Docker Compose build..."
          echo "ðŸ“ Build context: $(pwd)"
          echo "ðŸ“¦ Output will be written to: ./dist/"
          docker compose run --rm build
      
      - name: Verify dist artifacts
        run: |
          echo "ðŸ” Verifying build artifacts..."
          ls -la dist/
          echo ""
          test -f dist/manifest.json || { echo "âŒ manifest.json missing"; exit 1; }
          test -d dist/background || { echo "âŒ background bundle missing"; exit 1; }
          test -d dist/popup || { echo "âŒ popup bundle missing"; exit 1; }
          test -d dist/content_scripts || { echo "âŒ content_scripts bundle missing"; exit 1; }
          echo "âœ… All required artifacts present"
      
      - name: Package extension (zip)
        run: |
          echo "ðŸ“¦ Creating installable zip package via centralized packager..."
          # Use package script to create release zip
          npm run package
          VERSION=$(node -e "console.log(require('./package.json').version)")
          RELEASE_ZIP=$(ls -t release/*.zip 2>/dev/null | head -n1 || true)
          if [ -z "$RELEASE_ZIP" ]; then
            echo "Error: no release zip found in release/" >&2
            exit 1
          fi
          DOCKER_ZIP=smruti-cortex-v${VERSION}-docker.zip
          cp "$RELEASE_ZIP" "$DOCKER_ZIP"
          echo "âœ… Created: $DOCKER_ZIP ($(du -h $DOCKER_ZIP | cut -f1))"
      
      - name: Upload dist artifacts
        uses: actions/upload-artifact@v4
        with:
          name: extension-dist-docker
          path: dist/
          retention-days: 7
      
      - name: Upload zip package
        uses: actions/upload-artifact@v4
        with:
          name: smruti-cortex-docker-zip
          path: smruti-cortex-v${{ env.SMRUTI_CORTEX_VERSION }}-docker.zip
          retention-days: 7
      
      - name: Show artifact summary
        run: |
          echo "## ðŸ‹ Docker Build Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Build Status:** âœ… Success" >> $GITHUB_STEP_SUMMARY
          echo "**Docker Image:** smruti-cortex:${{ env.SMRUTI_CORTEX_VERSION }}" >> $GITHUB_STEP_SUMMARY
          echo "**Trigger:** ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“¦ Produced Artifacts" >> $GITHUB_STEP_SUMMARY
          echo "1. **extension-dist-docker** (7 days) - Unzipped dist/ folder" >> $GITHUB_STEP_SUMMARY
          echo "2. **smruti-cortex-v${{ env.SMRUTI_CORTEX_VERSION }}-docker.zip** (7 days) - Ready-to-install zip" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“ Build Output" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          ls -lh dist/ >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“Š Package Details" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "Zip package: $(du -h smruti-cortex-v${{ env.SMRUTI_CORTEX_VERSION }}-docker.zip | cut -f1)" >> $GITHUB_STEP_SUMMARY
          echo "Total files: $(find dist -type f | wc -l)" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### â„¹ï¸ What This Workflow Does" >> $GITHUB_STEP_SUMMARY
          echo "- Builds Docker image with all dependencies isolated" >> $GITHUB_STEP_SUMMARY
          echo "- Runs \`npm run build\` inside container" >> $GITHUB_STEP_SUMMARY
          echo "- Verifies all required bundles are present" >> $GITHUB_STEP_SUMMARY
          echo "- Creates installable zip package" >> $GITHUB_STEP_SUMMARY
          echo "- Uploads both dist/ folder and zip for download" >> $GITHUB_STEP_SUMMARY
          echo "- **Does NOT commit or push changes**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ’¡ Usage" >> $GITHUB_STEP_SUMMARY
          echo "Download \`smruti-cortex-v${{ env.SMRUTI_CORTEX_VERSION }}-docker.zip\` and load unpacked in Chrome/Edge." >> $GITHUB_STEP_SUMMARY
