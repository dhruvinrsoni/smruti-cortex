name: Deploy Landing Page

on:
  push:
    branches:
      - main
    paths:
      - 'site/**'
      - '.github/workflows/deploy-site.yml'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Configure Git
        run: |
          git config --global user.name "GitHub Actions Bot"
          git config --global user.email "actions@github.com"
      
      - name: Backup privacy.html (if present)
        run: |
          # If docs/privacy.html already exists, back it up. If not, we'll rely on site/privacy.html.
          if [ -f docs/privacy.html ]; then
            cp docs/privacy.html /tmp/privacy.html.backup
            cp docs/privacy.html /tmp/privacy.html.backup2
            echo "âœ… Privacy policy backed up (2 copies)"
            echo "PRIVACY_BACKUP_EXISTS=true" >> $GITHUB_ENV
          else
            echo "âš ï¸ No existing docs/privacy.html found. Will use site/privacy.html if present."
            echo "PRIVACY_BACKUP_EXISTS=false" >> $GITHUB_ENV
          fi
      
      - name: Clean docs directory (except privacy.html)
        run: |
          if [ -d docs ]; then
            find docs -mindepth 1 ! -name 'privacy.html' -delete
            echo "âœ… Cleaned docs directory"
          else
            mkdir -p docs
            echo "âœ… Created docs directory"
          fi

      - name: Set up Node.js (for optional scripts)
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Generate screenshots index (optional)
        run: |
          # Generate site/screenshots/list.json if screenshots exist. Non-fatal if missing.
          node ./scripts/generate-screenshots-index.mjs || true
      
      - name: Copy site files to docs
        run: |
          cp -r site/* docs/
          echo "âœ… Copied site files to docs/"
      
      - name: Restore or ensure privacy.html (CRITICAL - NEVER FAIL)
        run: |
          # Priority: existing backup -> site/privacy.html -> error
          if [ -f /tmp/privacy.html.backup ]; then
            cp /tmp/privacy.html.backup docs/privacy.html
            echo "âœ… Privacy policy restored from primary backup"
          elif [ -f /tmp/privacy.html.backup2 ]; then
            cp /tmp/privacy.html.backup2 docs/privacy.html
            echo "âš ï¸ Privacy policy restored from secondary backup"
          elif [ -f site/privacy.html ]; then
            cp site/privacy.html docs/privacy.html
            echo "âœ… Privacy policy copied from site/privacy.html"
          else
            echo "âŒ CRITICAL: No privacy policy found in backups or site/privacy.html"
            echo "ðŸš¨ Aborting deployment to prevent privacy URL breakage"
            exit 1
          fi
          echo "ðŸ”’ Privacy URL preserved at: docs/privacy.html"
      
      - name: Verify deployment
        run: |
          echo "ðŸ“ Deployed files:"
          ls -la docs/
          echo ""
          if [ -f docs/privacy.html ]; then
            echo "âœ… Privacy policy verified at docs/privacy.html"
          else
            echo "âŒ ERROR: Privacy policy missing!"
            exit 1
          fi
          if [ -f docs/index.html ]; then
            echo "âœ… Landing page verified at docs/index.html"
          else
            echo "âŒ ERROR: Landing page missing!"
            exit 1
          fi
      
      - name: Commit and push changes
        run: |
          git add docs/
          if git diff --staged --quiet; then
            echo "â„¹ï¸ No changes to deploy"
          else
            git commit -m "ðŸš€ Deploy landing page [skip ci]

            - Updated from site/ directory
            - Privacy policy preserved at docs/privacy.html
            - Deployed by GitHub Actions
            
            Timestamp: $(date -u +'%Y-%m-%d %H:%M:%S UTC')"
            
            # Try to push with retry logic
            MAX_RETRIES=3
            RETRY_COUNT=0
            until git push origin main || [ $RETRY_COUNT -eq $MAX_RETRIES ]; do
              RETRY_COUNT=$((RETRY_COUNT+1))
              echo "âš ï¸ Push failed, retrying ($RETRY_COUNT/$MAX_RETRIES)..."
              sleep 5
            done
            
            if [ $RETRY_COUNT -eq $MAX_RETRIES ]; then
              echo "âŒ Failed to push after $MAX_RETRIES attempts"
              echo "ðŸ”’ Privacy policy backup preserved in /tmp/"
              exit 1
            fi
            
            echo "âœ… Deployment successful!"
          fi
      
      - name: Summary
        run: |
          echo "## ðŸš€ Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… Landing page deployed successfully" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“ Live URLs" >> $GITHUB_STEP_SUMMARY
          echo "- **Landing Page:** https://dhruvinrsoni.github.io/smruti-cortex/" >> $GITHUB_STEP_SUMMARY
          echo "- **Privacy Policy:** https://dhruvinrsoni.github.io/smruti-cortex/privacy.html" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“ Deployed Files" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          ls -la docs/ >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ”’ Privacy policy preserved and verified" >> $GITHUB_STEP_SUMMARY
