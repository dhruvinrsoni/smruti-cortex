name: Deploy Landing Page

# Purpose: Copies site/ folder to docs/ for GitHub Pages hosting.
# Produces: No artifacts - directly commits and pushes to main branch.
# Use case: Automated site deployment when site files change.
# âš ï¸ IMPORTANT: This workflow COMMITS and PUSHES changes back to repository!
#              Always run `git pull` before making local commits after this runs.
# Safeguard: Preserves privacy.html to avoid breaking Chrome Web Store URL.

on:
  push:
    branches:
      - main
    paths:
      - 'site/**'
      - '.github/workflows/deploy-site.yml'
  workflow_dispatch:
    inputs:
      target_branch:
        description: 'Target branch for deployment (default: main - commits to docs/)'
        required: false
        default: 'main'
        type: string
      source_branch:
        description: 'Source branch to deploy from (default: main)'
        required: false
        default: 'main'
        type: string
      node_version:
        description: 'Node.js version to use (default: 22)'
        required: false
        default: '22'
        type: string
      commit_message:
        description: 'Custom commit message'
        required: false
        default: 'ðŸš€ Deploy site updates'
        type: string

permissions:
  contents: write

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ inputs.source_branch || 'main' }}
      
      - name: Pre-deployment safety checks
        run: |
          echo "ðŸ” Running pre-deployment safety checks..."
          
          # Check if we're on the correct branch
          CURRENT_BRANCH=$(git branch --show-current)
          TARGET_BRANCH="${{ inputs.target_branch || 'main' }}"
          
          if [ "$CURRENT_BRANCH" != "$TARGET_BRANCH" ]; then
            echo "âš ï¸ Current branch ($CURRENT_BRANCH) differs from target branch ($TARGET_BRANCH)"
            echo "This workflow is designed to deploy to docs/ on the target branch."
          fi
          
          # Check for uncommitted changes in docs/ directory
          if [ -d docs ] && git status --porcelain docs/ | grep -q .; then
            echo "âŒ ERROR: Uncommitted changes detected in docs/ directory"
            echo "This could indicate a previous deployment failure or manual changes."
            echo "Please commit or stash changes in docs/ before deploying."
            git status docs/
            exit 1
          fi
          
          # Check if branch is ahead/behind remote
          AHEAD_BEHIND=$(git status -b --porcelain | head -1)
          if echo "$AHEAD_BEHIND" | grep -q '\[ahead\|behind\]'; then
            echo "âš ï¸ Branch is not in sync with remote. This may cause deployment conflicts."
            echo "Status: $AHEAD_BEHIND"
            echo "Consider pulling latest changes before deployment."
          fi
          
          # Verify source files exist
          if [ ! -d site ]; then
            echo "âŒ ERROR: site/ directory not found"
            echo "Cannot deploy: no source files to copy"
            exit 1
          fi
          
          if [ ! -f site/index.html ]; then
            echo "âŒ ERROR: site/index.html not found"
            echo "Cannot deploy: landing page missing"
            exit 1
          fi
          
          echo "âœ… Pre-deployment checks passed"
      
      - name: Configure Git
        run: |
          git config --global user.name "GitHub Actions Bot"
          git config --global user.email "actions@github.com"
      
      - name: Backup current docs state (for rollback)
        run: |
          if [ -d docs ]; then
            echo "ðŸ“¦ Creating backup of current docs/ state..."
            mkdir -p /tmp/docs-backup
            cp -r docs/* /tmp/docs-backup/ 2>/dev/null || true
            echo "âœ… Backup created at /tmp/docs-backup/"
            echo "ROLLBACK_AVAILABLE=true" >> $GITHUB_ENV
          else
            echo "â„¹ï¸ No existing docs/ directory to backup"
            echo "ROLLBACK_AVAILABLE=false" >> $GITHUB_ENV
          fi
      
      - name: Clean docs directory (except privacy.html)
        run: |
          if [ -d docs ]; then
            find docs -mindepth 1 ! -name 'privacy.html' -delete
            echo "âœ… Cleaned docs directory"
          else
            mkdir -p docs
            echo "âœ… Created docs directory"
          fi

      - name: Set up Node.js (for optional scripts)
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Generate screenshots index (optional)
        run: |
          # Generate site/screenshots/list.json if screenshots exist. Non-fatal if missing.
          node ./scripts/generate-screenshots-index.mjs || true
      
      - name: Copy site files to docs
        run: |
          cp -r site/* docs/
          echo "âœ… Copied site files to docs/"
      
      - name: Restore or ensure privacy.html (CRITICAL - NEVER FAIL)
        run: |
          # Priority: existing backup -> site/privacy.html -> error
          if [ -f /tmp/privacy.html.backup ]; then
            cp /tmp/privacy.html.backup docs/privacy.html
            echo "âœ… Privacy policy restored from primary backup"
          elif [ -f /tmp/privacy.html.backup2 ]; then
            cp /tmp/privacy.html.backup2 docs/privacy.html
            echo "âš ï¸ Privacy policy restored from secondary backup"
          elif [ -f site/privacy.html ]; then
            cp site/privacy.html docs/privacy.html
            echo "âœ… Privacy policy copied from site/privacy.html"
          else
            echo "âŒ CRITICAL: No privacy policy found in backups or site/privacy.html"
            echo "ðŸš¨ Aborting deployment to prevent privacy URL breakage"
            exit 1
          fi
          echo "ðŸ”’ Privacy URL preserved at: docs/privacy.html"
      
      - name: Verify deployment
        run: |
          echo "ðŸ“ Deployed files:"
          ls -la docs/
          echo ""
          if [ -f docs/privacy.html ]; then
            echo "âœ… Privacy policy verified at docs/privacy.html"
          else
            echo "âŒ ERROR: Privacy policy missing!"
            exit 1
          fi
          if [ -f docs/index.html ]; then
            echo "âœ… Landing page verified at docs/index.html"
          else
            echo "âŒ ERROR: Landing page missing!"
            exit 1
          fi
      
      - name: Commit and push changes
        id: deploy
        run: |
          git add docs/
          if git diff --staged --quiet; then
            echo "â„¹ï¸ No changes to deploy"
            echo "DEPLOYMENT_STATUS=no-changes" >> $GITHUB_ENV
          else
            git commit -m "${{ inputs.commit_message || 'ðŸš€ Deploy landing page [skip ci]' }}

            - Updated from site/ directory
            - Privacy policy preserved at docs/privacy.html
            - Deployed by GitHub Actions

            Timestamp: $(date -u +'%Y-%m-%d %H:%M:%S UTC')"
            
            # Try to push with retry logic
            MAX_RETRIES=3
            RETRY_COUNT=0
            until git push origin ${{ inputs.target_branch || 'main' }} || [ $RETRY_COUNT -eq $MAX_RETRIES ]; do
              RETRY_COUNT=$((RETRY_COUNT+1))
              echo "âš ï¸ Push failed, retrying ($RETRY_COUNT/$MAX_RETRIES)..."
              sleep 5
            done
            
            if [ $RETRY_COUNT -eq $MAX_RETRIES ]; then
              echo "âŒ Failed to push after $MAX_RETRIES attempts"
              echo "DEPLOYMENT_STATUS=failed" >> $GITHUB_ENV
              echo "TRIGGER_ROLLBACK=true" >> $GITHUB_ENV
              exit 1
            fi
            
            echo "âœ… Deployment successful!"
            echo "DEPLOYMENT_STATUS=success" >> $GITHUB_ENV
          fi
      
      - name: Rollback on deployment failure
        if: failure() && env.TRIGGER_ROLLBACK == 'true' && env.ROLLBACK_AVAILABLE == 'true'
        run: |
          echo "ðŸ”„ Deployment failed! Attempting rollback..."
          
          # Restore docs/ from backup
          if [ -d /tmp/docs-backup ]; then
            rm -rf docs/*
            cp -r /tmp/docs-backup/* docs/ 2>/dev/null || true
            git add docs/
            
            # Commit rollback
            git commit -m "ðŸ”„ ROLLBACK: Revert failed deployment
            
            - Restored docs/ from pre-deployment backup
            - Deployment failed, reverting to previous state
            
            Timestamp: $(date -u +'%Y-%m-%d %H:%M:%S UTC')" --allow-empty
            
            # Try to push rollback
            if git push origin ${{ inputs.target_branch || 'main' }}; then
              echo "âœ… Rollback successful - previous state restored"
            else
              echo "âŒ Rollback push failed - manual intervention required"
              echo "ðŸ“¦ Backup preserved at /tmp/docs-backup/"
              exit 1
            fi
          else
            echo "âŒ No backup available for rollback"
          fi
      
      - name: Final validation
        if: env.DEPLOYMENT_STATUS == 'success'
        run: |
          echo "ðŸ” Running final validation..."
          
          # Verify GitHub Pages will work
          if [ ! -f docs/index.html ]; then
            echo "âŒ ERROR: docs/index.html missing after deployment"
            exit 1
          fi
          
          if [ ! -f docs/privacy.html ]; then
            echo "âŒ ERROR: docs/privacy.html missing after deployment"
            exit 1
          fi
          
          # Check file permissions
          if [ ! -r docs/index.html ] || [ ! -r docs/privacy.html ]; then
            echo "âŒ ERROR: Deployed files are not readable"
            exit 1
          fi
          
          echo "âœ… Final validation passed"
      
      - name: Summary
        if: always()
        run: |
          echo "## ðŸš€ Site Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ env.DEPLOYMENT_STATUS }}" = "success" ]; then
            echo "âœ… **Deployment Successful**" >> $GITHUB_STEP_SUMMARY
          elif [ "${{ env.DEPLOYMENT_STATUS }}" = "failed" ]; then
            echo "âŒ **Deployment Failed** - Rollback attempted" >> $GITHUB_STEP_SUMMARY
          elif [ "${{ env.DEPLOYMENT_STATUS }}" = "no-changes" ]; then
            echo "â„¹ï¸ **No Changes** - Site already up to date" >> $GITHUB_STEP_SUMMARY
          else
            echo "âš ï¸ **Deployment Status Unknown**" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“ Live URLs" >> $GITHUB_STEP_SUMMARY
          echo "- **Landing Page:** https://dhruvinrsoni.github.io/smruti-cortex/" >> $GITHUB_STEP_SUMMARY
          echo "- **Privacy Policy:** https://dhruvinrsoni.github.io/smruti-cortex/privacy.html" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ -d docs ]; then
            echo "### ðŸ“ Deployed Files" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            ls -la docs/ >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "### ðŸ›¡ï¸ Safety Features" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Pre-deployment conflict detection" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Source file validation" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Privacy policy preservation (3-level backup)" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Automatic rollback on failure" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Branch sync verification" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Final validation checks" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "### âš ï¸ IMPORTANT" >> $GITHUB_STEP_SUMMARY
          echo "This workflow pushes commits back to \`${{ inputs.target_branch || 'main' }}\`." >> $GITHUB_STEP_SUMMARY
          echo "**Always run \`git pull\` before making local commits after this runs!**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ env.ROLLBACK_AVAILABLE }}" = "true" ]; then
            echo "ðŸ”„ Rollback capability: Available (backup preserved)" >> $GITHUB_STEP_SUMMARY
          fi
